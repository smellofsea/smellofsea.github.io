---
layout:     post   				    # 使用的布局（不需要改）
title:      虚拟存储器				    # 标题 
subtitle:                     #副标题
date:       2020-10-14 				# 时间
author:     smellofsea 						# 作者
header-img:            	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - 操作系统
---

存储器的管理方式均为将一个作业全部装入内存，但是会出现一些问题：  
1、作业很大，所要求的内存超过内存总容量。  
2、有大量作业要求运行，只能将少量作业装入内存，大量作业在外存。  
解决方案：1、增加内存容量。2、从逻辑上扩充内存容量。  

### 虚拟存储器的工作原理
将当前要云运行的页（段）装入内存，若程序要访问的页（段）不在内存，发出页（段）中断请求，OS调相应页（段）进入内存。若内存已满，则OS利用页（段）的置换功能，将内存中暂时不用的页（段）调至盘上，将要访问的页（段）调入内存。

### 虚拟存储器的定义
虚拟存储器是指具有调入功能和置换功能，能从逻辑上对内存容量扩充的存储器系统。  
特征：1、多次性。2、对换性。3、虚拟性。虚拟性是以多次性和对换性为基础的，多次性和对换性又必须建立在离散分配的基础上。
## 虚拟存储器的实现方法
### 分页请求系统
请求分页系统是建立在基本分页的基础，增加了请求调页功能和页面置换功能。
#### 请求分页的硬件支持
 1、请求页表机制：  
在请求页表增加了四个四段  
|页表|物理块号|状态位P|访问字段A|修改位M|外存地址|
|--|--|--|--|--|--|
状态位P:指示页是否已调入内存。  
访问字段A：记录本页在一段时间内被访问的次数，或记录多久没被访问。  
修改位：标识该页调入内存后是否被修改，保证外存上的副本始终是最新的。  
2、缺页中断系统：  
当所要访问的页面不在内存，产生一缺页中断，请求OS将所缺页调入内存。需要有CPU保护、分析中断原因、转入缺页中断处理程序进行处理，以及在中断处理完成后在恢复CPU环境等操作。但是有和一般的中断有一些区别：  
- 在指令执行期间产生和处理终端信号。   
- 一条指令在执行期间可能产生多次缺页中断。  

3、地址变换机构 操作系统书P158

#### 请求分页中的内存分配
1、最小物理块数的确定：  
最小物理块数是指能保证进程正常运行所需的最小物理块数。取决于计算机的指令的格式、功能和寻址方式。  
2、内存分配策略：  
- 固定分配局部置换  
固定分配：为每个进程分配一个固定数目的物理块。  
局部置换：进程运行时发现缺页，只能从分配给该进程的页面中选出一个换出，然后再调入一页。  
困难在于：应为给每个进程分配多少物理块。  
- 可变分配全局置换：  
可变分配：先为每个进程分配一定的物理块，运行时可根据情况适当的增加和减少。  
全局置换：运行时发现缺页将空闲的物理块分配给该进程。被选择的进程拥有的物理块会减少，导致缺页率增加。
- 可变分配局部置换  
为每个进程分配一定数目的物理块，当发现缺页时，值允许该进程在内存中选择一页换出。如果进程频繁出现缺页中断，系统再为进程分配若干附加的物理块。若缺页率特别低，可适当减少分配给该进程的物理块数。知道适合的缺页率。

3、物理块分配算法
- 平均分配算法：将系统中所有可供分配的物理块平均分配给各个进程。
- 按比例分配算法：根据进程的大小按比例分配物理块。
- 考虑优先级的分配算法：把可供分配的物理块分为两部分：一部分按比例分配，另一部分根据优先级分配。  
#### 页面调度策略
1、何时调入页面：
- 预调页策略：将预计在不久之后边被访问的页面预先调入内存。  
- 请求调页策略：当进程运行时发现需要访问的部分程序和数据所在的页面不在内存，便立即提出请求，由OS将页面调入内存。但是每次只能调入一页，系统开销大。  

2、从何处调入页面：
- 系统拥有足够的对换区空间：全部从对换区调入所需页面。在进程运行前，将与该进程有关的文件从文件去拷贝到对换区。
- 系统缺少足够的对换区：凡不会修改的文件直接从文件区调入。可能被修改的文件，将他们换出时调到对换区。
- UNIX方式：凡是未运行过的页面都从文件区调用，曾经运行过又被换出的页面，被存放在对换区，下次从对换区调入。UNIX系统允许页面共享，进程所请求的页面可能已被其他进程调用内存，无需再从对换区调用。

3、页面调用过程：

4、缺页率：
进程逻辑空间为n，分配的内存物理块数为m，访问成功次数为S，访问失败次数为F，缺页率为f=F/(S+F);
### 页面置换算法 
#### 最佳置换算法
选择的被淘汰的页是以后永不使用或者很长时间内都不会再被访问的页面。但是人们目前无法预知那些不被访问。
#### 先进先出页面置换算法
总是先淘汰最先进入内存的页面。把调入内存的页面按先后顺序连接成一个队列，设置一个指针。
#### 最近最久未使用置换算法（LRU）
该算法赋予每个页面一个访问字段记录页面的自上次访问后经历的时间t，当要淘汰页面是选择t最大的。  
硬件支持：
#### 最少使用置换算法
为内存中的每页设置一个访问寄存器，选取较大的时间间隔记录对存储器某页的访问。
#### Clock置换算法
1、简单的Clock置换算法  
为每页设置一位访问位，将内存中的页面通过链接指针链接成一个循环队列。当某页被访问时，访问位置1。选择一页淘汰时，检查进程的访问位，是0则选择，是1置为0，检查下一个页面，一直循环。该算法又称为最近未使用算法或NRU算法。  
2、改进型Clock置换算法  
P167


















