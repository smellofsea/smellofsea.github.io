---
layout:     post                    # 使用的布局（不需要改）
title:       线程               # 标题 
subtitle:                           #副标题
date:       2020-10-22              # 时间
author:     smellofsea            # 作者
header-img:       #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    操作系统
---

# 线程 
### 线程提出的原因
- 将应用程序分解成可以运行的多个顺序线程，使程序设计模型变得更简单
- 线程比进程更轻量级，更容易创建和撤销
- 如果存在大量的计算和I/O处理，多个线程会加快执行速度。
- 真正的并行有了实现的可能
### 线程的目的
共享一组资源的多个线程的执行能力，以便这些线程可以为完成某一任务而共同工作
### 线程与进程的比较
- 调度的基本单位。线程是调度和分派的基本单位。
- 并发性。线程使OS拥有更好的并发性
- 拥有资源。进程是拥有资源的基本单位，线程仅拥有一点必不可少的，保证独立运行的资源。
- 独立性。进程拥有独立的地址空间，同一进程的线程拥有相同的内存地址空间和资源。
### 每个线程的内容
- 程序计数器
- 寄存器
- 堆栈：存放相应过程的的局部变量以及过程调用完之后使用的返回地址。
- 状态：TCB
#### TCB
- 线程标识符
- 寄存器
- 线程运行状态：运行、阻塞、就绪、终止
- 优先级
- 线程专用存储区：线程切换时存放现场保护指针
- 信号屏蔽
- 堆栈指针
## 线程的实现的方式
### 用户级方式
把线程包放在用户空间，内核对线程包一无所知。
#### 优点
（1） 用户级线程包可以在不支持线程的操作系统上实现。  
（2） 线程切换至少比陷入内核快一个数量级：TCB在用户空间中，管理线程切换的线程库在用户地址空间运行。  
（3）允许每个进程有自己定制的调度算法：在不干扰进程的情况下可以根据自身需求选择不同的调度算法，对自己的线程管理和调度。  
#### 缺点
（1）系统调用的阻塞问题：当一个线程执行系统调用阻塞，会使整个进程的线程阻塞。  
解决方法：  
1、系统调用全改为非阻塞的，但是要修改OS。不可取  
2、如果某个调用会阻塞，就提前通知。  
（2）页面故障。和阻塞问题类似，当某个程序调用或跳转到不在内存的指令，会发生页面故障。  
（3）一个线程开始运行，该进程的其他线程就不能运行，除非自己放弃CPU
### 内核支持线程
TCB在内核中，通过系统调用对线程进行操作。  
#### 优点
（1） 内核可以同时调度同一进程的多个线程并执行。  
（2）一个线程阻塞了，内核可以调度该进程的其他线程占有处理机。
（3）当线程撤销时，把它标志为不可运行，但是其内核数据并没有受到影响。在创建新线程时，重新启动某个旧线程，节省开销。
#### 缺点
（1）用于用户的线程切换，切换开销比较大：在同一个进程中，一个线程切换到另一个线程需要用户态到核心态进行。系统开销大。
### 混合方式
把用户级线程和内核支持线程进行组合。  
采用用户线程和内核线程复用的方法。  
内核识别内核级线程，并对其调度。一些内核级线程会被多个用户级线路复用。

### 线程的实现
#### 内核支持线程的实现
（1）系统在创建新进程时便为它分配了一个任务数据区（PTDA），包括若干TCB。  
（2）每当进程创建线程时，便为新进程分配一个TCB，将有关信息填入TCB，并为之分配必要的资源。
（3）当PTDA的所有TCB被分配完了，只要其创建的线程没超过系统允许值，系统再为之分配新的TCB空间。
（4）撤销一个线程时，也应该收回该线程的所有资源和TCB。
#### 用户级线程的实现
用户级线程在用户空间实现。所有的用户级线程都有相同的结构。  
（1）运行时系统  
实质是用于管理和控制线程的函数的集合，包括创建和撤销线程的函数、线程同步和通信的函数，实现线程调度的函数。  
正是因为这些函数才使得用户线程与内核无关。运行时系统的所有函数都驻留在用户空间。  
无论传统的OS，还是多线程OS，系统资源都由内核管理。传统OS，进程利用OS提供的系统调用来请求系统资源的。用户级线程是不能利用系统调用的。当线程需要系统调用，将该要求传送给运行时系统，通过相应的系统调用来获得系统资源。  
（2）内核控制线程  






